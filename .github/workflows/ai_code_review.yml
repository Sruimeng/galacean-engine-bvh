name: PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    environment: AI
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write # å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™æ— æ³•å‘è¡¨è¯„è®º
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # å»ºè®®ä½¿ç”¨ç¨³å®šç‰ˆ v4
        with:
          fetch-depth: 0

      - name: PR Review with Claude
        id: review
        uses: anthropics/claude-code-action@v1
        env:
          # å¦‚æœä½ åœ¨å›½å†…æˆ–è€…ä½¿ç”¨ä»£ç†ï¼Œå¯èƒ½éœ€è¦ä¿ç•™ BASE_URLï¼Œå¦åˆ™å¯åˆ é™¤
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          # è¿™é‡Œé€šå¸¸ç›´æ¥ç”¨ GitHub å†…ç½®çš„ Token å³å¯ï¼Œä¸éœ€è¦é¢å¤–é…ç½® Secret
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: ${{ secrets.ANTHROPIC_MODEL }}
          use_sticky_comment: true # å¼€å¯åä¼šæ›´æ–°åŒä¸€æ¡è¯„è®ºï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½å‘æ–°çš„
          show_full_output: true
          prompt: |
            è¯·å¯¹å½“å‰ PR è¿›è¡Œå…¨é¢å®¡æŸ¥.

            ## å®¡æŸ¥ç»´åº¦
            **ä»£ç è´¨é‡**ï¼šä»£ç é£æ ¼ã€å¤æ‚åº¦ã€é‡å¤ä»£ç ã€å‘½åè§„èŒƒã€é”™è¯¯å¤„ç†ã€æ½œåœ¨ bug
            **æ¶æ„è®¾è®¡**ï¼šé¡¹ç›®ç»“æ„ä¸€è‡´æ€§ã€ä¾èµ–åˆç†æ€§ã€è®¾è®¡æ¨¡å¼ã€å…³æ³¨ç‚¹åˆ†ç¦»

            ## è¾“å‡ºæ ¼å¼ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰
            è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºå®¡æŸ¥æŠ¥å‘Šï¼š

            ## ğŸ” PR ä»£ç å®¡æŸ¥æŠ¥å‘Š

            ### ğŸ“‹ æ¦‚è¦
            - **å˜æ›´æ–‡ä»¶æ•°**: {changedFiles}
            - **æ–°å¢/åˆ é™¤è¡Œæ•°**: +{additions} / -{deletions}

            ### ğŸ¯ å®¡æŸ¥ç»“è®º
            {APPROVE/REQUEST_CHANGES/COMMENT åŠç®€è¦è¯´æ˜}

            ### ğŸ”´ ä¸¥é‡é—®é¢˜ (Critical)
            {ä¸¥é‡é—®é¢˜åˆ—è¡¨ï¼Œå¦‚æ— åˆ™æ˜¾ç¤º"æ— "}

            ### ğŸŸ  é‡è¦é—®é¢˜ (Important)
            {é‡è¦é—®é¢˜åˆ—è¡¨ï¼Œå¦‚æ— åˆ™æ˜¾ç¤º"æ— "}

            ### ğŸŸ¢ æ”¹è¿›å»ºè®® (Suggestions)
            {æ”¹è¿›å»ºè®®åˆ—è¡¨ï¼Œå¦‚æ— åˆ™æ˜¾ç¤º"æ— "}

            ### ğŸ’¡ æ€»ä½“è¯„ä»·
            {å¯¹æœ¬æ¬¡ PR çš„æ•´ä½“è¯„ä»·}

            ## æ³¨æ„äº‹é¡¹
            1. æ‰€æœ‰è¯„è®ºä½¿ç”¨ç®€ä½“ä¸­æ–‡
            2. ç»™å‡ºå…·ä½“çš„æ–‡ä»¶åå’Œè¡Œå·
            3. å¯¹å¥½çš„å®è·µä¹Ÿè¦ç»™äºˆè‚¯å®š
            4. ä¿æŒå®¢è§‚ã€ä¸“ä¸š
            5. ç›´æ¥è°ƒç”¨ `gh pr comment` å‘å¸ƒä¸€æ¡å®Œæ•´çš„è¯„è®ºï¼Œä¸è¦åˆ†å¤šæ¡ã€‚

            ALWAYS Answer in ç®€ä½“ä¸­æ–‡.
          # ç§»é™¤äº† --json-schemaï¼Œå› ä¸ºæ²¡æœ‰é£ä¹¦æ­¥éª¤åï¼Œæˆ‘ä»¬ä¸éœ€è¦å¼ºåˆ¶å®ƒè¾“å‡ºæœºå™¨å¯è¯»çš„ JSON ç»Ÿè®¡äº†
          claude_args: |
            --model ${{ secrets.ANTHROPIC_MODEL }} --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep,Task"
